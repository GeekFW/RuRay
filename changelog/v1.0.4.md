# RuRay v1.0.4 更新日志

## 🚀 新功能

### TUN模式透明代理实现
- **智能流量转发**: 实现了基于代理服务器状态的智能流量转发逻辑
  - 当有代理服务器运行时，外网流量自动通过代理转发
  - 当没有代理服务器运行时，流量直接连接，正常上网
  - 本地、私有网络、系统服务流量始终直接连接，不经过代理

- **路由表优化**: 改进了Windows平台的路由表配置
  - 使用分割路由方式（0.0.0.0/1 和 128.0.0.0/1）避免路由循环
  - 添加路由备份和恢复机制
  - 设置TUN设备接口度量值优化路由优先级
  - 支持路由规则的安全添加和删除

- **动态代理端口**: 实现了动态获取代理端口配置
  - 自动从应用配置中读取SOCKS5代理端口
  - 支持配置文件更新后的端口变更
  - 提供默认端口1080作为后备方案

## 🔧 技术改进

### 代理状态检测
- 添加了`ProxyManager::is_process_running()`同步方法
- 优化了TUN模块中的代理状态检查逻辑
- 避免在数据包处理中使用异步操作，提升性能

### 流量转发优化
- 完善了TCP和UDP流量的SOCKS5代理转发
- 改进了代理连接失败时的降级处理
- 增强了错误处理和日志记录

### 安全性提升
- 确保管理员权限检查
- 优化路由表操作的安全性
- 防止路由配置冲突

## 📁 文件变更

### 修改的文件
- `src-tauri/src/tun.rs`: 核心TUN模式实现
  - 新增智能代理检测逻辑
  - 优化路由表配置方法
  - 改进流量转发机制
  - 添加动态端口获取功能

- `src-tauri/src/proxy.rs`: 代理管理器增强
  - 新增`is_process_running()`公共方法
  - 优化代理状态检测接口

## 🎯 用户体验

### 透明代理体验
- 用户开启TUN模式后，系统流量自动根据代理状态智能转发
- 无需手动配置系统代理设置
- 支持所有应用程序的透明代理
- 代理服务器启停时流量转发自动切换

### 稳定性提升
- 改进的路由表管理避免了网络连接问题
- 优化的错误处理确保系统稳定运行
- 增强的日志记录便于问题诊断

## 📋 技术细节

### 路由策略
- 使用0.0.0.0/1和128.0.0.0/1分割路由覆盖所有IPv4地址
- 避免了传统0.0.0.0/0路由可能导致的循环问题
- 保持原有默认路由作为备份

### 流量分类
- 本地回环地址（127.0.0.0/8）: 直接连接
- 私有网络地址（10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16）: 直接连接
- 链路本地地址（169.254.0.0/16）: 直接连接
- 组播和广播地址: 直接连接
- 系统服务端口（DNS 53, DHCP 67/68等）: 直接连接
- 其他外网地址: 根据代理状态决定转发方式

---

**注意**: TUN模式需要管理员权限才能正常工作，请确保以管理员身份运行应用程序。